<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@jmeade11">
  <meta name="twitter:creator" content="@jmeade11">
  <meta name="twitter:title" content="US Unemployment Rates for August 2016">
  <meta name="twitter:description" content="A demo of a cholopleth build with D3.js using data from publicly available sources showing unemployment rates across the U.S. in August 2016.">
  <meta name="twitter:image" content="https://www.javascriptninja.pro/img/choropleth.png">
  <title>US Unemployment Rates for August 2016</title>
  <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js" integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      font-family: sans-serif;
    }
    body {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font: 15px sans-serif;
      padding-bottom: 1rem;
    }
    header {
      padding: 1em;
      text-align: center;
    }
    a {
      background-color: #dc3545;
      text-decoration: none;
      display: inline-block;
      padding: .15rem .25rem;
      color: white;
    }
    p {
      margin: .75em auto .5;
      max-width: 50rem;
      text-align: left;
    }
    .container {
      position: relative;
    }
    .container div {
      opacity: 0;
      transition: opacity .5s ease-in-out;
    }
    .container div.popover {
      position: absolute;
      top: 25%;
      left: calc(50% - 6rem);
      height: 6rem;
      width: 12rem;
      background-color: rgba(255,255,255,.9);
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      box-shadow: 5px 5px 5px rgba(0,0,0,.25);
      opacity: 1;
    }
    .popover::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -1rem;
      border-width: 1rem;
      border-style: solid;
      border-color: rgba(255,255,255,.9) transparent transparent transparent;
    }
    .popover h4 {
      color: #555;
    }
    .popover h2 {
      margin-top: .45rem;
      color: #000;
    }
    .active {
      fill: #aaa;
    }
    svg:not([data-icon]) {
      max-width: 100%;
      cursor: pointer;
    }
    .counties {
      fill: none;
      stroke: #fff;
      stroke-width: 0.25px;
    }
    .states {
      fill: none;
      stroke: #fff;
      stroke-linejoin: round;
    }
    .county {
      cursor: pointer;
    }
    .legend-bg {
      fill: rgba(255,255,255,.75);
    }
    .tick text {
      font-size: 12px;
    }
    button {
      color: #dc3545;
      background-color: rgba(255,255,255,.75);
      background-image: none;
      outline: 0;
      cursor: pointer;
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      user-select: none;
      border: 1px solid #dc3545;
      padding: .375rem .75rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: .25rem;
      transition: color .15s ease-in-out,
        background-color .15s ease-in-out,
        border-color .15s ease-in-out,
        box-shadow .15s ease-in-out;
    }
    button:active, button:hover {
      color: #fff;
      background-color: #dc3545;
      border-color: #dc3545;
    }
    button:active {
      box-shadow: none;
    }
    button:hover {
      box-shadow: 0 0 0 0.2rem rgba(220,53,69,.5);
      outline: 0;
    }

    @media (max-width: 768px) {
      .key {
        transform: scale(3) translate(25px,250px);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>U.S. Unemployment Rates</h1>
    <h3>as of August, 2016</h3>
    <h4>Based on <a href="https://bl.ocks.org/mbostock/4060606" target="_blank">M. Bostock's Choropleth Example <i class="fas fa-external-link-alt"></i></a></h4>
    <p>Choropleth example updated for v5. Population, rate, county and state names displayed on click. Zoom and popovers have been added and the map is responsive for mobile viewing.</p>
  </header>
  <div class="container"></div>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script>
  const config = {w: 960, h: 600, range: 10, legend: {w: 30, h: 10, bands: 9}}

  const container = d3.select('.container');

  const popover = container.append('div');

  const svg = container.append('svg')
    .attr('width', config.w)
    .attr('height', config.h)
    .attr('viewBox','0 0 '+config.w+' '+config.h)
    .attr('preserveAspectRatio','xMidYMid')
    .on('click', stopped, true);

  const features = svg.append('g');

  let active = d3.select(null);

  const zoom = d3.zoom()
    .scaleExtent([1, 20])
    .on('zoom', zoomed);

  const unemployment = d3.map();

  const path = d3.geoPath();

  const x = d3.scaleLinear()
    .domain([1, config.range])
    .rangeRound([0,config.legend.w * config.legend.bands])

  const color = d3.scaleThreshold()
    .domain(d3.range(2, config.range))
    .range(d3.schemeReds[9]);

  d3.select('button')
    .on('click', reset);

  d3.json('us.json')
    .then(d => us = d)
    .then(function(){
      d3.csv('unemployment.csv', d => {
        unemployment.set(d.id, {rate: parseFloat(d.rate), cnty: d.cnty, state: d.state, pop: d3.format(',')(d.pop)});
      })
      .then(() => {
        buildMap(us, unemployment);
        addLegend();
      })
    });

  function buildMap(us, unemployment) {
    features.append('g')
      .attr('class', 'counties')
    .selectAll('path')
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append('path')
      .attr('fill', d => {
        d.details = unemployment.get(d.id);
        return color(d.details.rate);
      })
      .attr('d', path)
      .attr('class', 'county')
      .on('click', zoomToBounds)
    .append('title')
      .text(d => d.details.rate + '%');

    features.append('path')
      .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
      .attr('class', 'states')
      .attr('d', path);
  }

  function addLegend() {
    const legend = svg.append('g')
      .attr('class', 'key')
      .attr('transform', `translate(${config.w / 2},${config.h - 40})`);

    legend.append('rect')
      .attr('width', config.legend.w * config.range)
      .attr('height', config.legend.h * 5)
      .attr('y', -config.legend.h * 2)
      .attr('x', -config.legend.w / 2)
      .attr('class', 'legend-bg')

    legend.selectAll('rect.band')
      .data(color.range().map(d => {
        d = color.invertExtent(d);
        if (d[0] == null) d[0] = x.domain()[0];
        if (d[1] == null) d[1] = x.domain()[1];
        return d;
      }))
      .enter().append('rect')
        .attr('height', config.legend.h)
        .attr('x', (d, i) => config.legend.w * i)
        .attr('width', config.legend.w)
        .attr('fill', d => color(d[0]));

    legend.append('text')
      .attr('class', 'caption')
      .attr('x', x.range()[0])
      .attr('y', -6)
      .attr('fill', 'crimson')
      .attr('text-anchor', 'start')
      .attr('font-weight', 'bold')
      .text('Unemployment Rate');

    legend.call(
      d3.axisBottom(x)
        .tickSize(config.legend.h + 2)
        .tickFormat((x, i) => i ? x : x + '%')
        .tickValues(color.domain())
      )
      .select('.domain')
      .remove();
  }

  function zoomed() {
    features.attr('transform', d3.event.transform);
  }

  function zoomToBounds(d) {

    if (active.node() === this) return reset();
    active.classed('active', false);
    active = d3.select(this).classed('active', true);

    popover
      .classed('popover', true)
      .selectAll('*').remove();

    var bounds = path.bounds(d),
        dx = bounds[1][0] - bounds[0][0],
        dy = bounds[1][1] - bounds[0][1],
        x = (bounds[0][0] + bounds[1][0]) / 2,
        y = (bounds[0][1] + bounds[1][1]) / 2,
        scale = Math.max(1, Math.min(15, 0.9 / Math.max(dx / config.w, dy / config.h))),
        translate = [config.w / 2 - scale * x, config.h / 2 - scale * y];

    features
      .transition()
      .duration(750)
      .call(zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale));

    popover.append('h4').text(d.details.cnty+', '+d.details.state);
    popover.append('p').text('pop. '+d.details.pop);
    popover.append('h2').text(d.details.rate+'%');
  }

  function stopped() {
    if (d3.event.defaultPrevented) d3.event.stopPropagation();
  }

  function reset() {
    active.classed('active', false);
    active = d3.select(null);
    features.transition()
      .duration(1000)
      .call(zoom.transform, d3.zoomIdentity);
    popover.classed('popover', false).selectAll('*').remove();
  }

  features.call(zoom);
  </script>
</body>
</html>
